pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'us-east-1'
        DOTNET_VERSION = '9.0'
        SAM_STACK_PREFIX = 'lambda-testapp'
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                echo "üì¶ Branch atual: ${env.BRANCH_NAME}"
            }
        }

        stage('Restore & Build') {
            steps {
                dir('src/LambdaTestApp') {
                    echo "üîß Restaurando depend√™ncias e compilando..."
                    sh 'dotnet restore'
                    sh 'dotnet build --configuration Release'
                }
            }
        }

        stage('Build with AWS SAM') {
            steps {
                echo "üèóÔ∏è Gerando artefatos SAM..."

                sh '''
                export PATH="$PATH:/var/lib/jenkins/.dotnet/tools"
                sam build
                
                '''
            }
        }

        stage('Deploy with AWS SAM') {
            steps {
                script {
                    def stageName = env.BRANCH_NAME == 'master' ? 'prod' : env.BRANCH_NAME
                    def stackName = "${SAM_STACK_PREFIX}-${stageName}"

                    echo "üöÄ Fazendo deploy da fun√ß√£o Lambda existente (${stackName}) para ambiente: ${stageName}"

                    sh """
                        sam deploy \
                            --stack-name ${stackName} \
                            --capabilities CAPABILITY_IAM \
                            --parameter-overrides Stage=${stageName} \
                            --no-confirm-changeset \
                            --no-fail-on-empty-changeset
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Deploy realizado com sucesso para ${env.BRANCH_NAME}!"
        }
        failure {
            echo "‚ùå Falha no deploy para ${env.BRANCH_NAME}."
        }
    }
}
